<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Medico - Sign in</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <main class="auth login">
      <div class="auth-container">
        <div class="auth-left">
          <div class="auth-logo">
            <svg class="logo" width="36" height="36" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden>
              <rect rx="6" width="24" height="24" fill="#16a085" />
              <path d="M7 12h10M12 7v10" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span class="brand">Medico</span>
          </div>
          <div class="auth-inner">
            <h2>Welcome back</h2>
            <p class="muted">Sign in to your account to continue</p>

            <form id="login-form" class="auth-form" action="javascript:void(0);" autocomplete="off">
              <label>Username
                <input type="text" name="username" id="login-username" placeholder="Enter username" required>
              </label>

              <label>Password
                <input type="password" name="password" id="login-password" placeholder="********" required>
              </label>

              <button type="submit" class="btn-primary">Sign In</button>
            </form>

            <p class="muted">Don't have an account? <a href="signup.html">Sign up</a></p>
            <p class="muted">Admin access? <a href="admin-login.html">Admin Login</a></p>
          </div>
        </div>
        <div class="auth-right">
          <h3>Your Health, Simplified</h3>
          <p>AI-powered pharmacy management at your fingertips</p>
        </div>
      </div>
    </main>

    <footer class="site-footer"><div class="page-inner">Â© Medico</div></footer>
    <script>
      function getBackendBase() {
        const configured = String(localStorage.getItem('PHARMA_API_BASE') || '').replace(/\/+$/, '');
        if (configured) return configured;
        if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
          return String(window.location.origin || '').replace(/\/+$/, '');
        }
        return 'http://127.0.0.1:8000';
      }

      async function syncContactToBackend(username, phone) {
        const base = getBackendBase();
        try {
          await fetch(`${base}/users/contact/upsert`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, phone, days_supply: 30 }),
          });
        } catch {
          // Keep login flow functional even if backend is offline.
        }
      }

      // Simple client-side login: check localStorage and redirect
      document.getElementById('login-form').addEventListener('submit', async function(e){
        e.preventDefault();
        const username = document.getElementById('login-username').value.trim();
        const pw = document.getElementById('login-password').value;

        const users = JSON.parse(localStorage.getItem('cureos_users') || '[]');
        if(!Array.isArray(users) || users.length === 0) {
          return alert('No account found. Please sign up first.');
        }

        const matchedUser = users.find((user) =>
          String(user.username || '').toLowerCase() === username.toLowerCase()
        );

        if(!matchedUser) return alert('Invalid username.');
        if(String(matchedUser.password || '') !== pw) return alert('Incorrect password.');

        localStorage.setItem('cureos_user', JSON.stringify(matchedUser));
        localStorage.setItem('pharma_logged_in', 'true');
        localStorage.setItem('pharma_username', matchedUser.username);
        localStorage.setItem('pharma_clear_chat', 'true');
        await syncContactToBackend(matchedUser.username, matchedUser.phone);
        window.location.href = 'dashboard.html';
      });
    </script>
  </body>
</html>
