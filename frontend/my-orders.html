<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Medico - My Orders</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="topbar-inner">
        <div class="topbar-left">
          <a href="dashboard.html" class="back">‚Üê</a>
          <h2 class="chat-title">My Orders</h2>
        </div>
      </div>
    </header>

    <main class="page">
      <div class="page-inner">
        <h1 class="page-title">My Orders</h1>
        <p class="page-sub">Track your placed orders, totals, and recent activity</p>

        <section class="order-stats" id="order-stats">
          <article class="order-stat-card">
            <p class="order-stat-label">Total Orders</p>
            <p class="order-stat-value" id="stat-total-orders">0</p>
          </article>
          <article class="order-stat-card">
            <p class="order-stat-label">Total Spent</p>
            <p class="order-stat-value" id="stat-total-spent">EUR 0.00</p>
          </article>
          <article class="order-stat-card">
            <p class="order-stat-label">Last Order</p>
            <p class="order-stat-value" id="stat-last-order">-</p>
          </article>
        </section>

        <div class="table-shell">
          <table class="orders-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Medicine</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Total</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="orders-body"></tbody>
          </table>
        </div>
      </div>
    </main>

    <script>
      const ORDERS_STORAGE_KEY = "pharma_orders";

      function formatCurrency(v) {
        const value = Number(v || 0);
        if (!Number.isFinite(value)) return "EUR 0.00";
        return `EUR ${value.toFixed(2)}`;
      }

      function formatDate(iso) {
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return "-";
        return d.toLocaleString();
      }

      async function getInventoryPriceMap() {
        try {
          const base =
            (localStorage.getItem("PHARMA_API_BASE") || "").replace(/\/+$/, "") ||
            "http://127.0.0.1:8003";
          const res = await fetch(`${base}/inventory`);
          if (!res.ok) return {};
          const rows = await res.json();
          if (!Array.isArray(rows)) return {};
          return rows.reduce((acc, row) => {
            const key = String(row.medicine_name || "").trim().toLowerCase();
            const price = Number(row.price);
            if (key && Number.isFinite(price)) acc[key] = price;
            return acc;
          }, {});
        } catch {
          return {};
        }
      }

      async function loadOrders() {
        const username = localStorage.getItem("pharma_username") || "User";
        const allOrders = JSON.parse(localStorage.getItem(ORDERS_STORAGE_KEY) || "[]");
        const priceMap = await getInventoryPriceMap();
        const orders = allOrders
          .filter((o) => (o.username || "User") === username)
          .map((o) => {
            let unitPrice = Number(o.unit_price || 0);
            if (!Number.isFinite(unitPrice) || unitPrice <= 0) {
              unitPrice = Number(priceMap[String(o.medicine_name || "").toLowerCase()] || 0);
            }
            const qty = Number(o.quantity || 0);
            let totalPrice = Number(o.total_price || 0);
            if (!Number.isFinite(totalPrice) || totalPrice <= 0) {
              totalPrice = unitPrice * qty;
            }
            return { ...o, unit_price: unitPrice, total_price: totalPrice };
          })
          .sort((a, b) => new Date(b.ordered_at) - new Date(a.ordered_at));

        // Persist repaired prices for older zero-priced orders.
        const merged = allOrders.map((o) => {
          if ((o.username || "User") !== username) return o;
          const fixed = orders.find((x) =>
            x.ordered_at === o.ordered_at &&
            x.medicine_name === o.medicine_name &&
            Number(x.quantity || 0) === Number(o.quantity || 0)
          );
          return fixed || o;
        });
        localStorage.setItem(ORDERS_STORAGE_KEY, JSON.stringify(merged));

        const totalOrders = orders.length;
        const totalSpent = orders.reduce((sum, o) => sum + Number(o.total_price || 0), 0);
        const lastOrderText = totalOrders ? formatDate(orders[0].ordered_at) : "-";

        document.getElementById("stat-total-orders").textContent = String(totalOrders);
        document.getElementById("stat-total-spent").textContent = formatCurrency(totalSpent);
        document.getElementById("stat-last-order").textContent = lastOrderText;

        const tbody = document.getElementById("orders-body");
        if (!orders.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="orders-empty">No orders placed yet.</td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = orders.map((o) => `
          <tr>
            <td>${formatDate(o.ordered_at)}</td>
            <td class="orders-med-name">${o.medicine_name || "-"}</td>
            <td>${o.quantity || 0}</td>
            <td>${formatCurrency(o.unit_price)}</td>
            <td>${formatCurrency(o.total_price)}</td>
            <td><span class="order-status">Placed</span></td>
          </tr>
        `).join("");
      }

      loadOrders();
    </script>
  </body>
</html>
